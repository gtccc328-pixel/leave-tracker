<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—“ï¸ äº‹ã€ç—…å‡è¨˜éŒ„</title>
    <style>
        /* æº«å’Œè‰²èª¿å®šç¾© */
        :root {
            /* ç¶²é åº•è‰²æ”¹ç‚ºå¾ˆæ·¡çš„ç²‰ç´…è‰² */
            --color-bg: #fce9f1;         /* å¾ˆæ·¡çš„ç²‰ç´…è‰²èƒŒæ™¯ */
            --color-container: #ffffff;  /* ç™½è‰²å®¹å™¨ */
            --color-primary: #a78295;    /* æŸ”å’Œçš„ç²‰è‰²ä¸»è‰²èª¿ */
            --color-secondary: #f7e3eb;  /* ç¨å¾®æ·±ä¸€é»çš„æ·¡ç²‰ (è¡¨é ­) */
            --color-accent: #a9b9a6;     /* æ·¡ç¶ è‰²è£é£¾ */
            --color-highlight: #4a7c59;  /* æ·±ç¶ è‰²å¼·èª¿ (è¨˜éŒ„æŒ‰éˆ•) */
            --color-edit: #ffc107;       /* ä¿®æ”¹ (é»ƒè‰²) */
            --color-delete: #dc3545;     /* åˆªé™¤ (ç´…è‰²) */
        }

        /* åŸºç¤æ¨£å¼ */
        body { 
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Arial', sans-serif; 
            margin: 0; 
            padding: 20px; 
            text-align: center; 
            background-color: var(--color-bg); 
            color: #333;
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: var(--color-container); 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); 
        }
        h1 { 
            font-size: 28px; 
            margin-bottom: 25px; 
            color: var(--color-primary);
        }
        
        /* æ”¾å¤§å‰©é¤˜å‡åˆ¥é¡¯ç¤º */
        .leave-display {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
            padding: 20px 0;
            border-bottom: 3px solid var(--color-secondary);
        }
        .leave-display p { 
            font-size: 22px; 
            color: var(--color-highlight); 
            font-weight: bold;
            margin: 0;
        }

        /* è¨˜éŒ„æŒ‰éˆ• (å¼·èª¿è‰²) */
        #recordButton, .action-btn { 
            background-color: var(--color-highlight); 
            color: white; 
            padding: 12px 25px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            transition: background-color 0.3s, transform 0.1s; 
        }
        #recordButton { 
            width: 100%; 
            margin-top: 20px;
        }
        #recordButton:hover { 
            background-color: #386145; 
            transform: translateY(-1px);
        }
        
        /* æ­·å²è¨˜éŒ„è¡¨æ ¼æ¨£å¼ */
        h2 { 
            margin-top: 30px; 
            border-bottom: 2px solid var(--color-primary); 
            padding-bottom: 5px; 
            color: var(--color-primary); 
            font-size: 22px;
        }
        .history-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
            text-align: left; 
        }
        .history-table th, .history-table td { 
            border: 1px solid #ddd; 
            padding: 10px; 
            vertical-align: middle;
        }
        .history-table th { 
            background-color: var(--color-secondary); 
            font-weight: bold; 
            text-align: center;
        }
        .history-table td:last-child { 
            text-align: center; 
            min-width: 120px;
        }
        .history-table button { 
            margin: 2px; 
            padding: 6px 10px; 
            font-size: 13px;
            border-radius: 5px;
        }

        /* Modal (å½ˆå‡ºè¦–çª—) æ¨£å¼ */
        .modal {
            display: none; 
            position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6); 
            padding-top: 40px; 
        }
        .modal-content {
            background-color: var(--color-container); margin: 5% auto; padding: 25px; border: none;
            width: 90%; max-width: 700px; 
            border-radius: 10px; text-align: left;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: block; /* ä½¿ç”¨å€å¡Šä½ˆå±€ */
        }
        
        /* è®“å·¦å³å€å¡Šä¸¦æ’ */
        .modal-content #leaveForm > div:first-child {
            display: flex;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .modal-content #leaveForm > div:first-child {
                flex-direction: column; /* å°è¢å¹•ä¸‹å‚ç›´å †ç–Š */
            }
        }
        .modal-left, .modal-right {
            flex: 1; 
        }
        .close { color: #aaa; float: right; font-size: 32px; font-weight: bold; }
        .close:hover, .close:focus { color: var(--color-primary); text-decoration: none; cursor: pointer; }

        /* è¼¸å…¥èˆ‡é¸æ“‡å€å¡Š */
        .input-group { margin-bottom: 20px; }
        .step-buttons button { 
            border: 2px solid var(--color-primary); 
            background-color: #fcfcfc; 
        }
        .step-buttons button.selected { 
            background-color: var(--color-primary); 
            color: white; 
            border-color: var(--color-primary); 
        }
        .action-submit {
            background-color: var(--color-highlight); 
        }
        .action-submit:hover {
            background-color: #386145;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ—“ï¸ äº‹ã€ç—…å‡è¨˜éŒ„</h1>
    
    <div class="leave-display">
        <p id="personalLeaveDisplay">å°šå‰©é¤˜äº‹å‡ï¼šè¼‰å…¥ä¸­...</p>
        <p id="sickLeaveDisplay">å°šå‰©é¤˜ç—…å‡ï¼šè¼‰å…¥ä¸­...</p>
    </div>

    <button id="recordButton" onclick="openRecordModal()">è«‹å‡è¨˜éŒ„ (æ–°å¢/ä¿®æ”¹æ‰£å‡)</button>

    <h2>ğŸ§¾ æ­·å²è«‹å‡è¨˜éŒ„</h2>
    <table class="history-table">
        <thead>
            <tr>
                <th>ç·¨è™Ÿ</th>
                <th>æ—¥æœŸ</th>
                <th>å‡åˆ¥</th>
                <th>æ™‚æ•¸</th>
                <th>å‚™è¨»</th>
                <th>è¨˜éŒ„çš„æ™‚é–“</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="historyTableBody">
            </tbody>
    </table>
    
    <p class="note" style="margin-top: 20px; color: #6c757d; font-size: 12px;">
        æ‰€æœ‰è¨˜éŒ„å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ (localStorage)ã€‚
    </p>
</div>

<div id="recordModal" class="modal">
    <div class="modal-content">
        
        <form id="leaveForm" style="width: 100%;">
            <input type="hidden" id="recordIndex" value="-1">
            <input type="hidden" id="selectedType" value="">
            <input type="hidden" id="selectedHours" value="">

            <div>
                <div class="modal-left">
                    <span class="close" onclick="closeRecordModal()">&times;</span>
                    <h3 id="modalTitle" style="border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-top: 0;">æ–°å¢è«‹å‡è¨˜éŒ„</h3>

                    <div class="input-group">
                        <h4 style="margin-top: 0;">1. é¸æ“‡å‡åˆ¥ï¼š</h4>
                        <div class="step-buttons">
                            <button type="button" data-type="personal" onclick="selectLeaveType('personal', this)">äº‹å‡</button>
                            <button type="button" data-type="sick" onclick="selectLeaveType('sick', this)">ç—…å‡</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <h4>2. é¸æ“‡æ™‚æ•¸ï¼š</h4>
                        <div class="step-buttons" id="hoursOptions">
                            <button type="button" data-hours="1" onclick="selectHours(1, this)">1 å°æ™‚</button>
                            <button type="button" data-hours="2" onclick="selectHours(2, this)">2 å°æ™‚</button>
                            <button type="button" data-hours="3" onclick="selectHours(3, this)">3 å°æ™‚</button>
                            <button type="button" data-hours="4" onclick="selectHours(4, this)">åŠæ—¥ (4h)</button>
                            <button type="button" data-hours="8" onclick="selectHours(8, this)">å…¨æ—¥ (8h)</button>
                        </div>
                    </div>
                </div>
                
                <div class="modal-right">
                    <div class="input-group">
                        <h4>3. è«‹å‡æ—¥æœŸï¼š</h4>
                        <label for="leaveDate" style="font-weight: normal; margin-top: 0;">è«‹é¸æ“‡æˆ–è¼¸å…¥æ—¥æœŸ</label>
                        <input type="date" id="leaveDate" required style="width: 90%;"> 
                    </div>
                    
                    <div class="input-group">
                        <h4>4. å‚™è¨» (é¸å¡«)ï¼š</h4>
                        <textarea id="leaveNotes" rows="3" placeholder="ä¾‹å¦‚ï¼šçœ‹é†«ç”Ÿã€ç§äººäº‹å‹™..." style="width: 90%;"></textarea>
                    </div>
                </div>
            </div>

            <button type="button" onclick="submitLeaveRecord()" class="action-btn action-submit" style="width: 100%; font-size: 18px; margin-top: 25px;">å„²å­˜è¨˜éŒ„</button>
        </form>

    </div>
</div>

<script>
    // --- JavaScript æ ¸å¿ƒé‚è¼¯ ---
    const DAILY_HOURS = 8;
    const INITIAL_TOTAL_HOURS = 7 * DAILY_HOURS; 
    const TOTALS_KEY = 'leaveTotals';
    const RECORDS_KEY = 'leaveRecords';

    let LEAVE_TOTALS = {};
    let LEAVE_RECORDS = [];

    // --- è³‡æ–™è™•ç†èˆ‡æŒä¹…åŒ– ---

    function loadData() {
        const storedTotals = localStorage.getItem(TOTALS_KEY);
        LEAVE_TOTALS = storedTotals ? JSON.parse(storedTotals) : {
            personal: INITIAL_TOTAL_HOURS,
            sick: INITIAL_TOTAL_HOURS
        };
        
        const storedRecords = localStorage.getItem(RECORDS_KEY);
        try {
            LEAVE_RECORDS = storedRecords ? JSON.parse(storedRecords) : [];
        } catch (e) {
            console.error("Failed to load leave records:", e);
            LEAVE_RECORDS = []; 
        }

        if (typeof LEAVE_TOTALS.personal !== 'number') LEAVE_TOTALS.personal = INITIAL_TOTAL_HOURS;
        if (typeof LEAVE_TOTALS.sick !== 'number') LEAVE_TOTALS.sick = INITIAL_TOTAL_HOURS;
    }

    function saveData() {
        localStorage.setItem(TOTALS_KEY, JSON.stringify(LEAVE_TOTALS));
        localStorage.setItem(RECORDS_KEY, JSON.stringify(LEAVE_RECORDS));
    }

    // --- é¡¯ç¤ºæ›´æ–°èˆ‡è¨ˆç®— ---

    function formatHoursToDays(totalHours) {
        if (totalHours < 0) totalHours = 0; 
        const days = Math.floor(totalHours / DAILY_HOURS);
        const hours = (totalHours % DAILY_HOURS).toFixed(1); 
        return `${days} æ—¥ ${hours} å°æ™‚`;
    }
    
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'ç„¡è¨˜éŒ„æ™‚é–“';
        const date = new Date(timestamp);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
    }

    function recalculateAndDisplay() {
        LEAVE_TOTALS.personal = INITIAL_TOTAL_HOURS;
        LEAVE_TOTALS.sick = INITIAL_TOTAL_HOURS;

        LEAVE_RECORDS.forEach(record => {
            if (record.type === 'personal') {
                LEAVE_TOTALS.personal -= record.hours;
            } else if (record.type === 'sick') {
                LEAVE_TOTALS.sick -= record.hours;
            }
        });

        document.getElementById('personalLeaveDisplay').innerText = 
            `å°šå‰©é¤˜äº‹å‡ï¼š${formatHoursToDays(LEAVE_TOTALS.personal)}`;
        document.getElementById('sickLeaveDisplay').innerText = 
            `å°šå‰©é¤˜ç—…å‡ï¼š${formatHoursToDays(LEAVE_TOTALS.sick)}`;
        
        renderHistoryTable();
        saveData();
    }

    function renderHistoryTable() {
        const tableBody = document.getElementById('historyTableBody');
        tableBody.innerHTML = ''; 

        if (LEAVE_RECORDS.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">ç›®å‰æ²’æœ‰è«‹å‡è¨˜éŒ„ã€‚</td></tr>';
            return;
        }

        LEAVE_RECORDS.sort((a, b) => new Date(b.date) - new Date(a.date)); 

        LEAVE_RECORDS.forEach((record, index) => {
            const row = tableBody.insertRow();
            
            row.insertCell().innerText = index + 1;
            row.insertCell().innerText = record.date;
            row.insertCell().innerText = record.type === 'personal' ? 'äº‹å‡' : 'ç—…å‡';
            row.insertCell().innerText = `${record.hours} å°æ™‚`;
            
            const notesCell = row.insertCell();
            notesCell.innerText = record.notes || 'ç„¡'; 
            notesCell.style.color = record.notes ? '#333' : '#aaa';
            
            row.insertCell().innerText = formatTimestamp(record.timestamp);

            const actionCell = row.insertCell();
            
            const editButton = document.createElement('button');
            editButton.innerText = 'ä¿®æ”¹';
            editButton.className = 'action-btn';
            editButton.style.backgroundColor = 'var(--color-edit)'; 
            editButton.style.color = '#333';
            editButton.onclick = () => editLeaveRecord(index);
            
            const deleteButton = document.createElement('button');
            deleteButton.innerText = 'åˆªé™¤';
            deleteButton.style.backgroundColor = 'var(--color-delete)'; 
            deleteButton.className = 'action-btn';
            deleteButton.onclick = () => deleteLeaveRecord(index);

            actionCell.appendChild(editButton);
            actionCell.appendChild(deleteButton);
        });
    }

    // --- Modal ä»‹é¢æ§åˆ¶èˆ‡äº’å‹•é‚è¼¯ ---
    
    const recordModal = document.getElementById('recordModal');
    const modalTitle = document.getElementById('modalTitle');
    const form = document.getElementById('leaveForm');
    const leaveDateInput = document.getElementById('leaveDate');

    function openRecordModal() {
        form.reset();
        document.getElementById('recordIndex').value = -1;
        document.getElementById('selectedType').value = '';
        document.getElementById('selectedHours').value = '';
        document.getElementById('leaveNotes').value = ''; 
        
        leaveDateInput.value = new Date().toISOString().split('T')[0];

        document.querySelectorAll('.step-buttons button').forEach(btn => btn.classList.remove('selected'));

        modalTitle.innerText = "æ–°å¢è«‹å‡è¨˜éŒ„";
        recordModal.style.display = 'flex'; 
    }

    function closeRecordModal() {
        recordModal.style.display = 'none';
    }
    
    window.onclick = function(event) {
        if (event.target == recordModal) {
            closeRecordModal();
        }
    }

    function selectLeaveType(type, button) {
        document.getElementById('selectedType').value = type;
        button.parentNode.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
        button.classList.add('selected');
    }

    function selectHours(hours, button) {
        document.getElementById('selectedHours').value = hours;
        button.parentNode.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
        button.classList.add('selected');
    }

    function submitLeaveRecord() {
        const type = document.getElementById('selectedType').value;
        const date = document.getElementById('leaveDate').value;
        const hours = parseFloat(document.getElementById('selectedHours').value);
        const notes = document.getElementById('leaveNotes').value.trim(); 
        const index = parseInt(document.getElementById('recordIndex').value);
        
        if (!type || !date || !hours || hours <= 0) {
            alert('è«‹å‹™å¿…é¸æ“‡å‡åˆ¥ã€æ—¥æœŸå’Œæ™‚æ•¸ï¼');
            return;
        }

        const newRecord = {
            date: date,
            type: type, 
            hours: hours,
            notes: notes,
            timestamp: index === -1 ? Date.now() : LEAVE_RECORDS[index].timestamp 
        };
        
        if (index === -1) {
            LEAVE_RECORDS.push(newRecord);
            alert(`æˆåŠŸæ–°å¢ ${type === 'personal' ? 'äº‹å‡' : 'ç—…å‡'} ${hours} å°æ™‚çš„è¨˜éŒ„ï¼`);
        } else {
            LEAVE_RECORDS[index].date = date;
            LEAVE_RECORDS[index].type = type;
            LEAVE_RECORDS[index].hours = hours;
            LEAVE_RECORDS[index].notes = notes;
            alert(`æˆåŠŸä¿®æ”¹ç¬¬ ${index + 1} ç­†è¨˜éŒ„ï¼`);
        }
        
        recalculateAndDisplay(); 
        closeRecordModal();
    }

    // --- æ­·å²è¨˜éŒ„æ“ä½œ ---

    function editLeaveRecord(index) {
        const record = LEAVE_RECORDS[index];
        if (!record) return;

        modalTitle.innerText = "ä¿®æ”¹è«‹å‡è¨˜éŒ„";
        document.getElementById('recordIndex').value = index; 

        document.getElementById('selectedType').value = record.type;
        document.getElementById('leaveDate').value = record.date;
        document.getElementById('selectedHours').value = record.hours;
        document.getElementById('leaveNotes').value = record.notes || ''; 

        document.querySelectorAll('.step-buttons button').forEach(btn => {
            btn.classList.remove('selected');
            if (btn.getAttribute('data-type') === record.type) {
                btn.classList.add('selected');
            }
            if (parseFloat(btn.getAttribute('data-hours')) === record.hours) {
                btn.classList.add('selected');
            }
        });
        
        recordModal.style.display = 'flex'; 
    }

    function deleteLeaveRecord(index) {
        if (confirm(`ç¢ºå®šè¦åˆªé™¤ç¬¬ ${index + 1} ç­†è¨˜éŒ„ (${LEAVE_RECORDS[index].date}) å—ï¼Ÿ\nå‰©é¤˜æ™‚æ•¸å°‡æœƒé€£å‹•æ¢å¾©ã€‚`)) {
            LEAVE_RECORDS.splice(index, 1);
            recalculateAndDisplay(); 
            alert("è¨˜éŒ„å·²åˆªé™¤ï¼Œå‰©é¤˜æ™‚æ•¸å·²æ›´æ–°ã€‚");
        }
    }

    // --- ç¨‹å¼å•Ÿå‹•é» ---
    window.onload = function() {
        loadData();
        recalculateAndDisplay(); 
    }
</script>
</body>
</html>